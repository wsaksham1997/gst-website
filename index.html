<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GST Download Configuration</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f7fb;
  padding: 30px;
}

.container {
  max-width: 700px;
  margin: auto;
  background: white;
  padding: 25px;
  border-radius: 8px;
}

label { display:block; margin-top:12px; font-weight:bold; }
input, select {
  width:100%;
  padding:8px;
  margin-top:5px;
}

#monthProgress {
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:8px;
  margin-top:10px;
}

.month-box {
  padding:8px;
  text-align:center;
  border-radius:6px;
  background:#ddd;
}
.month-running { background:#90caf9; }
.month-done { background:#81c784; color:white; }
.month-failed { background:#e57373; color:white; }

button {
  margin-top:15px;
  padding:10px;
  cursor:pointer;
}

/* MODALS */
.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
}

.modal-content {
  background:white;
  width:420px;
  margin:10% auto;
  padding:20px;
  border-radius:8px;
  text-align:center;
}

/* CAPTCHA IMAGE */
#captchaImg {
  display:block;
  width:260px;
  height:auto;
  margin:15px auto;
  border:1px solid #ccc;
  background:#f0f0f0;
}
</style>
</head>

<body>

<div class="container">
<h2>GST Portal Download</h2>

<label>GSTIN</label>
<input id="gstid">

<label>Password</label>
<input id="password" type="password">

<label>Download Path</label>
<input id="path">

<label>Financial Year</label>
<select id="fy"></select>

<label>Month</label>
<select id="month"></select>

<label>
  <input type="checkbox" id="fullYear"> Entire FY
</label>

<label>Progress</label>
<div id="monthProgress"></div>

<button id="runBtn">Run Automation</button>
</div>

<!-- STATUS MODAL -->
<div id="jobModal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <pre id="modalMessage"></pre>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<!-- CAPTCHA MODAL -->
<div id="captchaModal" class="modal">
  <div class="modal-content">
    <h3>Enter CAPTCHA</h3>
    <img id="captchaImg" alt="Captcha will appear here">
    <input id="captchaText" placeholder="Enter captcha">
    <button id="captchaSubmitBtn">Submit Captcha</button>
  </div>
</div>

<script>
const API_BASE = "http://192.168.1.85:5000";

let CURRENT_JOB_ID = null;
let POLL_TIMER = null;
let POLLING_PAUSED = false;

/* INIT FY & MONTH */
const fy = document.getElementById("fy");
const month = document.getElementById("month");
const fullYear = document.getElementById("fullYear");

const months = ["April","May","June","July","August","September",
"October","November","December","January","February","March"];

const y = new Date().getFullYear();
for (let i=2017;i<=y;i++) {
  fy.add(new Option(`${i}-${String(i+1).slice(-2)}`,`${i}-${String(i+1).slice(-2)}`));
}
months.forEach(m=>month.add(new Option(m,m)));
fullYear.onchange=e=>month.disabled=e.target.checked;

/* UI HELPERS */
function renderMonths(list){
  const box=document.getElementById("monthProgress");
  box.innerHTML="";
  list.forEach(m=>{
    const d=document.createElement("div");
    d.id="m-"+m;
    d.className="month-box";
    d.innerText=m;
    box.appendChild(d);
  });
}

function showModal(t,m){
  modalTitle.innerText=t;
  modalMessage.innerText=m;
  jobModal.style.display="block";
}
function closeModal(){ jobModal.style.display="none"; }

/* CAPTCHA FLOW â€” FINAL */
function showCaptcha(jobId){
  if (captchaModal.style.display === "block") return;

  POLLING_PAUSED = true;
  captchaText.value = "";
  captchaModal.style.display = "block";

  setTimeout(() => {
    captchaImg.src =
      `${API_BASE}/captcha/${jobId}?t=${Date.now()}&r=${Math.random()}`;
  }, 100);
}

captchaSubmitBtn.onclick = () => {
  const text = captchaText.value.trim();
  if (!text) return alert("Enter captcha");

  fetch(`${API_BASE}/submit-captcha/${CURRENT_JOB_ID}`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({captcha:text})
  })
  .then(()=>{
    captchaModal.style.display="none";
    captchaImg.src = "";
    POLLING_PAUSED = false;
  });
};

/* DOWNLOAD */
async function autoDownload(url){
  const r=await fetch(url);
  const b=await r.blob();
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="GST_2B.zip";
  a.click();
}

/* POLLING */
function poll(jobId){
  POLL_TIMER = setInterval(()=>{
    if (POLLING_PAUSED) return;

    fetch(`${API_BASE}/job-status/${jobId}`)
    .then(r=>r.json())
    .then(d=>{

      if (d.status==="WAITING_FOR_CAPTCHA"){
        showCaptcha(jobId);
        return;
      }

      Object.entries(d.months||{}).forEach(([m,s])=>{
        const el=document.getElementById("m-"+m);
        if(!el)return;
        el.className="month-box "+
          (s==="RUNNING"?"month-running":
           s==="COMPLETED"?"month-done":
           s==="FAILED"?"month-failed":"");
      });

      if(d.status==="COMPLETED"){
        clearInterval(POLL_TIMER);
        showModal("Completed","Download will start automatically");
        autoDownload(API_BASE + d.download_url);
      }
    });
  },4000);
}

/* RUN */
runBtn.onclick=()=>{
  const all=fullYear.checked;
  renderMonths(all?months:[month.value]);

  fetch(`${API_BASE}/run-gstr2b`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      gstin:gstid.value,
      password:password.value,
      fy:fy.value,
      only_fy:all,
      month:all?"":month.value,
      path:path.value,
      client:"DEFAULT"
    })
  })
  .then(r=>r.json())
  .then(d=>{
    CURRENT_JOB_ID=d.job_id;
    showModal("Started",`Job ID: ${d.job_id}`);
    poll(d.job_id);
  });
};
</script>

</body>
</html>

